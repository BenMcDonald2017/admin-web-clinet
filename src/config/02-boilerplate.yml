service:          ${self:custom.service.NAME}

frameworkVersion: ">=1.23.0 <2.0.0"

plugins:
  - serverless-plugin-webpack
  - serverless-aws-documentation
  - serverless-domain-manager
  - serverless-offline

package:
  individually:           true # package each lambda function individually
  excludeDevDependencies: false # we lean on webpack do the tree-shaking
  exclude:                ['node_modules/**/aws-sdk/**']

custom:
  service:
    NAME:         ${file(package.json):name}
    STAGE:        ${opt:stage, env:NODE_ENV, file(package.json):config.stage}
    REGION:       ${opt:region, file(package.json):config.region}
    RUNTIME:      ${file(package.json):config.runtime}
    VERSION:      ${file(package.json):version}
    DESCRIPTION:  ${file(package.json):description}
    GW_URL:
      Fn::Join:
        - ""
        - - https://
          - Ref: ApiGatewayRestApi
          - .execute-api.${self:custom.service.REGION}.amazonaws.com/${self:custom.service.STAGE}

  documentation:
    description:  Hixme API | ${self:custom.service.DESCRIPTION}
    summary:      ${self:custom.service.DESCRIPTION}
    version:      ${self:custom.service.VERSION}
    models:       ${file(schemas/models.yml)}
    # authorizers:  ${file(schemas/authorizers.yml)}
    # resources:    ${file(schemas/resources.yml)}

  environment:    &environment
    DOMAIN:       ${file(./env.js):getDomainName}
    REGION:       ${self:custom.service.REGION}
    SERVICE:      ${self:custom.service.NAME}
    STAGE:        ${self:custom.service.STAGE}
    URL_PATH:     ${file(./env.js):getAPIBasePath}
    VERSION:      ${self:custom.service.VERSION}

  customDomain:
    basePath:             ${file(./env.js):getAPIBasePath} # 'application'
    certificateName:      "*.hixme.com"
    createRoute53Record:  false # has already been done
    domainName:           ${file(./env.js):getDomainName}
    stage:                ${file(./env.js):packageStageName}

provider:
  name:       aws
  memorySize: 1024
  timeout:    30
  deploymentBucket:
    # Deployment bucket name. Default is generated by the framework
    # name: com.serverless.${self:provider.region}.deploys
    # using server-side encryption
    serverSideEncryption: AES256
  runtime:    ${self:custom.service.RUNTIME}
  stage:      ${self:custom.service.STAGE}
  region:     ${self:custom.service.REGION}
  stackTags:  *environment
  environment:
    <<:               *environment
    GW_URL:           ${self:custom.service.GW_URL}
    NODE_ENV:         ${env:NODE_ENV, self:custom.service.STAGE}
  iamRoleStatements:  ${self:custom.iamRoleStatements}
